import { useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { TeaSubmission } from '@/types/teaFeed';

// Simple AI comment type to avoid deep instantiation issues
export interface SimpleAIComment {
  id: string;
  content: string;
  type: 'spicy' | 'smart' | 'memy' | 'savage';
  submission_id: string;
  created_at: string;
}

export type CommentsMap = Record<string, SimpleAIComment[]>;

export const useEnhancedAIComments = () => {
  const [aiComments, setAiComments] = useState<CommentsMap>({});

  const generateAICommentary = async (submission: TeaSubmission, type: 'spicy' | 'smart' | 'memy' | 'savage' = 'spicy') => {
    try {
      const { data, error } = await supabase.functions.invoke('generate-ai-commentary-enhanced', {
        body: { 
          content: submission.content,
          category: submission.category,
          submissionId: submission.id,
          commentaryType: type
        }
      });

      if (error) throw error;
      
      if (data?.commentary) {
        const newComment: SimpleAIComment = {
          id: Date.now().toString(),
          content: data.commentary,
          type: type,
          submission_id: submission.id,
          created_at: new Date().toISOString()
        };

        setAiComments(prevComments => {
          const currentComments = prevComments[submission.id] || [];
          return {
            ...prevComments,
            [submission.id]: [...currentComments, newComment]
          };
        });
      }
    } catch (error) {
      if (process.env.NODE_ENV === "development") { console.error('useEnhancedAIComments - Error generating AI commentary:', error);
    }
  };

  return {
    aiComments,
    generateAICommentary
  };
};
